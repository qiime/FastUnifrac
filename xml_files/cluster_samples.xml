<!--
	author = Jose Antonio Navas Molina
	copyright = Copyright 2013, The FastUniFrac Project
	credits = Jose Antonio Navas Molina
	license = GPL
	version = 1.7.0-dev
	maintainer = Jose Antonio Navas Molina
	email = josenavasmolina@gmail.com
	status = Development
-->
<tool id="cluster_samples" name="Cluster samples" version="1.7.0-dev">
	<description>Uses the UniFrac metric to cluster the samples based on phylogenetic lineages they contain.</description>
	<command>
		check_id_map.py -m $category_map_file -s -o check_output;
		#from os.path import join, basename
		#set $mapping_fp = join('check_output', basename(str($category_map_file)) + '_corrected.txt')
		convert_sample_id_map_to_otu_table.py -i $sample_id_file -o otu_table.biom;
		beta_diversity.py -i otu_table.biom -t $tree_file -o ./output
		#if $use_abundance_weights.weights:
			#if $use_abundance_weights.normalized:
				-m weighted_normalized_unifrac;
				#set filename = 'output/weighted_normalized_unifrac_otu_table.txt'
			#else:
				-m weighted_unifrac;
				#set filename = 'output/weighted_unifrac_otu_table.txt'
			#end if
		#else:
			-m unweighted_unifrac;
			#set filename = 'output/unweighted_unifrac_otu_table.txt'
		#end if
		upgma_cluster.py -i $filename -o $cluster_samples_output;
		make_cluster_samples_file.py -t $cluster_samples_output -m $mapping_fp -o $output_html --output_dir=$output_html.files_path
	</command>
	<inputs>
		<param name="tree_file" type="data" label="Select reference tree"/>
		<param name="sample_id_file" type="data" label="Select sample ID mapping file"/>
		<param name="category_map_file" type="data" label="Select category mapping file"/>
		<conditional name="use_abundance_weights">
			<param name="weights" type="boolean" default="False" label="Use abundance weights"/>
			<when value="true">
				<param name="normalized" type="boolean" default="false" label="Normalized"/>
			</when>
		</conditional>
	</inputs>
	<outputs>
		<data format="txt" name="cluster_samples_output"/>
        <data format="html" name="output_html"/>
	</outputs>
	<stdio>
		<exit_code range="1:" level="fatal"/>
	</stdio>
	<help>
The **Cluster Samples** option can be used to determine which samples in the tree have similar microbial communities. It performs hierarchical clustering analysis (also known as UPGMA) on the samples based on a distance matrix that is generated by calculating pairwise UniFrac values (see illustration below). It only make sense to run analysis on input trees that have sequences from at least three samples.

.. image:: ./static/images/fastunifrac/cluster_samples/unifrac_clustering.jpg

**Clustering samples with Fast UniFrac.** *The tree on the left has sequences from 3 different samples colored red, yellow, and blue. UniFrac values are calculated for all possible pairs of samples to create a distance matrix. This matrix is used to cluster the samples using UPGMA (Unweighted Pair Group Method with Arithmetic Mean). The resulting cluster illustrates that the red and yellow samples are more similar to each other than either is to the blue sample.*

---------------------
Use abundance weights
---------------------

When the **No** option is selected, it uses the standard unweighted UniFrac algorithm to perform the calculations. If the **Yes** option is selected, it uses the weighted UniFrac algorithm; when the weighted sub-option **Normalized** is selected, it performs a normalization step in the weighted UniFrac value calculation, whereas the **Non-normalized** option this normalization is not applied.

-------------
Output format
-------------

The output of **Cluster Samples** is a text representation of the tree with the samples shown on it. Similar samples will appear clustered together in the tree. The tree contains the samples, not the sequences, and is drawn so that the root is on the left and the samples are on the right. The scale bar shows the distance between clusters in UniFrac units: a distance of 0 means that two samples are identical, and a distance of 0,5 means that two samples contain mutually exclusive lineages. The tree in Newick format can be used to view the clustering using other programs such as TreeView.

.. image:: ./static/images/fastunifrac/cluster_samples/output_example.jpg

Note that the method for clustering the samples is independent of the method used to build the phylogenetic tree of sequences: tipically, you will want to use an algorithm such as neighbor-joining, likelihood, parsimony, or Bayesian inference to build your phylogenetic tree. Hierarchical clustering is appropriate here because we are looking purely at distances between samples, and are not claiming that one sample evolved from another.
	</help>
</tool>
